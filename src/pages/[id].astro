---
import "../components/game.scss";

import { Image } from 'astro:assets';
import { getCollection, getEntry, render } from 'astro:content';
import slugify from 'slugify';
import Downloads from "../components/Downloads.astro";
import { getImg } from "../components/images";
import Layout from '../components/Layout.astro';

export async function getStaticPaths() {
	return (await getCollection('games')).map((game) => ({
		params: {
			id: game.id,
		},
	}));
}

const entry = (await getEntry('games', Astro.params.id));
if (!entry) throw new Error('could not find game');
const { data: game } = entry;
const [
	{ Content },
	banner,
	border,
	bgImage,
	social = `assets/covers/${slugify(game.title, { strict: true })}.png`
] = await Promise.all([
	render(entry),
	getImg(`/${entry.filePath?.replace('.mdx', '-banner') || ''}`),
	getImg(`/${entry.filePath?.replace('.mdx', '-border') || ''}`),
	getImg(`/${entry.filePath?.replace('.mdx', '-bg') || ''}`),
	getImg(`/${entry.filePath?.replace('.mdx', '-social') || ''}`),
]);
---

<Layout
	title={game.title}
	description={game.description || ''}
	image={social}
	css={game.css}
	bgImage={bgImage}
>

<main style={{
	borderImageSource: border ? `url("${border.src}")` : undefined,
	borderInlineWidth: border ? `${border.width / 2}px` : undefined,
	maxWidth: `${(border ? border.width : 0) + 1280}px`,
}}>
	<h1>{
		banner ? <Image src={banner} alt={game.title} loading="eager" /> : game.title
	}</h1>

	<section class="embed">
		{game.embed && <iframe allow="autoplay; fullscreen *; geolocation; microphone; camera; midi; monetization; xr-spatial-tracking; gamepad; gyroscope; accelerometer; xr; cross-origin-isolated; web-share" src={game.embed} />}
	</section>
	<section class="description">
		<Content />
	</section>

	<Downloads downloads={game.downloads} />
</main>
</Layout>
